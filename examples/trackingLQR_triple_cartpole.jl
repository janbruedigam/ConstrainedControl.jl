U = [-4.103287549769938	-1.350191915095031	-0.2838412996141297	0.09324840974016409	0.19077024046466484	0.17698093545373061	0.12095805805318198	0.0510280141023409	-0.021237095074871107	-0.09116319306735657	-0.1569248474096587	-0.2178804395105871	-0.2738865712290467	-0.325014667461339	-0.37143283105668556	-0.41335565056327245	-0.4510220008537108	-0.4846844231099108	-0.5146033413444906	-0.5410433456358805	-0.5642704051648825	-0.5845495458901986	-0.6021428040702357	-0.6173073808413386	-0.6302939697547607	-0.6413452481354287	-0.6506945302927174	-0.6585645828839758	-0.6651666027831791	-0.6706993568735213	-0.6753484818373133	-0.6792859405282733	-0.6826696300639791	-0.685643135282006	-0.6883356200972178	-0.6908618481308287	-0.6933223232716466	-0.6958035400630818	-0.6983783335946488	-0.7011063182441774	-0.7040344046130472	-0.7071973842325111	-0.7106185717411012	-0.7143104947782586	-0.7182756220995562	-0.7225071211185771	-0.7269896364756209	-0.7317000818983985	-0.736608438139306	-0.7416785503296592	-0.7468689187543158	-0.7521334773677102	-0.7574223551847615	-0.7626826158694128	-0.7678589716259433	-0.7728944676370367	-0.7777311340702502	-0.7823106027762945	-0.7865746864662924	-0.7904659183975686	-0.793928051026152	-0.7969065124886033	-0.799348820052218	-0.8012049501117011	-0.8024276645615136	-0.8029727937427777	-0.8027994764401563	-0.8018703576937566	-0.8001517454720307	-0.7976137274747559	-0.7942302495773801	-0.7899791576514618	-0.7848422046234391	-0.7788050248626875	-0.7718570780790691	-0.7639915650246232	-0.7552053174157958	-0.7454986645154538	-0.7348752788821762	-0.7233420038127969	-0.7109086649669869	-0.6975878687229596	-0.683394789646778	-0.668346949535857	-0.6524639903156949	-0.6357674430241205	-0.6182804950334542	-0.6000277574817315	-0.5810350348451259	-0.5613290983596306	-0.5409374649520491	-0.5198881831081288	-0.49820962704170363	-0.47593030029480343	-0.4530786498328655	-0.42968289147492456	-0.40577084740779745	-0.38136979635603585	-0.3565063368533462	-0.33120626392504354	-0.3054944593744501	-0.2793947957152367	-0.2529300537248118	-0.22612185344648805	-0.19899059840466116	-0.17155543268897896	-0.14383421049639156	-0.11584347765857302	-0.087598464593835	-0.059113090118268284	-0.03039997545180872	-0.001470467783075028	0.027665327335713988	0.05699850544096918	0.08652131521835552	0.11622710387290858	0.14611025655308163	0.17616613055557717	0.20639098500587086	0.2367819067412114	0.267336733042984	0.2980539719022343	0.3289327204283981	0.359972582020467	0.39117358286479054	0.42253608830833483	0.45406071961045	0.48574827156105116	0.5175996314012054	0.5496156994547267	0.5817973118565182	0.6141451657098009	0.6466597469821987	0.6793412614278769	0.7121895687637801	0.7452041203269414	0.7783839003917419	0.8117273712970048	0.8452324225179494	0.8788963237790415	0.9127156822733726	0.9466864040602225	0.9808036596449057	1.015061853761471	1.0494545993342197	1.0839746955940206	1.1186141102895668	1.1533639659212886	1.1882145299343043	1.223155208743406	1.2581745455048166	1.2932602214979487	1.3283990609831622	1.363577039406735	1.3987792947820423	1.4339901421009993	1.4691930906095065	1.504370863777508	1.53950542177088	1.574577986280581	1.609569067497783	1.644458493065324	1.679225438822319	1.7138484611529572	1.7483055307686688	1.7825740677209208	1.816630977490029	1.850452687952417	1.8840151870746593	1.917294061141138	1.950264533373402	1.9829015027661703	2.015179583001643	2.0470731412752348	2.0785563369095588	2.1096031596199047	2.140187467283559	2.1702830231409482	2.1998635322474995	2.2289026771378344	2.2573741525813706	2.2852516993142347	2.3125091367241652	2.3391203943623795	2.3650595422611254	2.390300819973459	2.414818664305769	2.4385877356975394	2.461582943218487	2.483779468165808	2.5051527862352247	2.525678688269967	2.5453332995827003	2.564093097850737	2.5819349296039906	2.5988360253338736	2.6147740132063295	2.629726931483832	2.6436732396069993	2.6565918280334118	2.6684620268695	2.6792636133138727	2.6889768180005027	2.6975823302844195	2.7050613025066395	2.7113953533446176	2.7165665702584922	2.7205575111438036	2.723351205226467	2.72493115328031	2.7252813272343066	2.72438616923393	2.722230590232961	2.7187999681816803	2.714080145877072	2.708057428544721	2.7007185812391166	2.6920508260970535	2.6820418395491017	2.6706797495026935	2.657953132658955	2.64385101187713	2.6283628538374955	2.611478566874252	2.593188499206441	2.5734834374949904	2.5523546058752284	2.5297936654799416	2.5057927145196315	2.4803442889597807	2.453441363882087	2.425077355540396	2.3952461242072443	2.3639419778115816	2.3311596764517657	2.296894437815233	2.261141943550965	2.22389834662823	2.1851602797473237	2.1449248648029493	2.1031897234761505	2.0599529889414203	2.0152133187770733	1.9689699090404291	1.9212225096032751	1.8719714406793735	1.8212176106778422	1.7689625352506195	1.7152083576797712	1.659957870513392	1.6032145384732106	1.5449825226499172	1.4852667059217157	1.4240727196138598	1.3614069713310748	1.2972766739951052	1.2316898758974923	1.1646554918935659	1.0961833355266761	1.0262841520563282	0.954969652324457	0.8822525473114822	0.8081465833333928	0.7326665776830724	0.6558284546489509	0.5776492817348708	0.4981473058845687	0.41734198965849684	0.33525404699132394	0.2519054785212889	0.16731960616266392	0.08152110675051263	-0.005463955506039365	-0.09360809797835938	-0.1828823902249186	-0.2732564265693566	-0.36469830081781307	-0.4571745835038981	-0.5506503018598852	-0.6450889228197434	-0.7404523393314537	-0.8367008602770369	-0.9337932042630251	-1.0316864975282614	-1.130336276298646	-1.2296964937329562	-1.3297195318228836	-1.4303562183372802	-1.5315558491173389	-1.6332662158204532	-1.7354336393073377	-1.8380030087471408	-1.9409178265870284	-2.044120259376866	-2.147551194532152	-2.2511503028992803	-2.354856107207966	-2.4586060561937697	-2.562336604239557	-2.66598329643519	-2.7694808586748363	-2.872763292625725	-2.975763975163261	-3.0784157619541963	-3.180651094661766	-3.2824021114962227	-3.383600760417211	-3.4841789146347373	-3.5840684897095776	-3.6832015617969365	-3.7815104863565834	-3.8789280166787523	-3.975387421769007	-4.070822602706279	-4.165168207083543	-4.258359740752957	-4.3503336763591225	-4.441027557983624	-4.530380101433774	-4.618331289549727	-4.70482246211228	-4.789796399789058	-4.873197401831856	-4.954971357031404	-5.035065807707204	-5.113430006384558	-5.190014965039972	-5.264773496656919	-5.337660249102966	-5.4086317311815195	-5.477646330958506	-5.5446643263675774	-5.609647888233976	-5.672561075917426	-5.733369825715114	-5.792041932336584	-5.84854702371906	-5.902856529527176	-5.954943643643342	-6.004783281090289	-6.052352029747703	-6.0976280972803405	-6.140591253720991	-6.181222770100182	-6.219505353621435	-6.255423079734319	-6.28896132159641	-6.320106677310262	-6.34884689532199	-6.375170798439975	-6.399068206734741	-6.420529859789144	-6.439547338534466	-6.456112987048938	-6.470219834566981	-6.4818615179671975	-6.491032204989873	-6.497726518394599	-6.501939461238658	-6.503666343462604	-6.502902709926548	-6.499644270020991	-6.493886828964575	-6.4856262208853055	-6.474858243764926	-6.461578596290752	-6.445782816695129	-6.427466223593995	-6.40662385889329	-6.383250432736162	-6.357340270582812	-6.328887262379395	-6.297884813878768	-6.26432580011961	-6.228202521078872	-6.189506659566392	-6.1482292413520145	-6.104360597616423	-6.057890329769364	-6.0088072767006295	-5.9570994845807945	-5.902754179281975	-5.845757741574514	-5.786095685229549	-5.723752638190464	-5.658712327010628	-5.590957564769066	-5.520470242688617	-5.447231325750879	-5.371220852564473	-5.292417939834628	-5.2108007917732255	-5.12634671482833	-5.039032138138557	-4.9488326401687806	-4.855722981965902	-4.75967714756404	-4.660668392041384	-4.558669297796143	-4.453651839613106	-4.3455874591210035	-4.234447149279786	-4.120201549517169	-4.002821052184631	-3.882275920990322	-3.758536422092653	-3.6315729684983418	-3.5013562784604595	-3.367857548487327	-3.231048641606548	-3.090902291475999	-2.947392322860687	-2.8004938889933166	-2.6501837262107064	-2.496440426222065	-2.33924472623594	-2.178579817041197	-2.0144316690855923	-1.8467893762922087	-1.6756455173664122	-1.500996533972574	-1.3228431250464943	-1.1411906562769942	-0.9560495833975821	-0.7674358878350552	-0.5753715227584852	-0.37988486736609334	-0.18101118683650347	0.02120690499884949	0.22671898357381726	0.43546635582970544	0.6473816109261331	0.8623881839325482	1.0803999374703497	1.3013207666111846	1.5250442327288136	1.7514532323038026	1.9804197070007792	2.211804401470138	2.445456675587395	2.681214377807994	2.9189037862954703	3.158339624367799	3.399325156455402	3.6416523703760375	3.8851022511843514	4.129445151015099	4.37444125864656	4.619841171208494	4.865386569501732	5.110810996869413	5.355840740153126	5.600195809699273	5.843591013610069	6.08573711984679	6.326342097898225	6.565112430109767	6.801754481077487	7.035975911984316	7.267487125342728	7.4960027244848515	7.7212429711716215	7.942935224066474	8.16081534051001	8.374629023994775	8.584133100191126	8.789096705008278	8.989302369387012	9.184546986770401	9.374642651125347	9.55941735522121	9.738715541259028	9.912398498170651	10.080344602624287	10.242449403180341	10.398625549684557	10.548802572439133	10.692926518055623	10.83095945101768	10.962878831940902	11.088676785113293	11.208359269268806	11.321945166511489	11.429465304988636	11.530961431202341	11.626485147861025	11.71609683281071	11.799864553966694	11.877862994285998	11.950172399707117	12.016877561685307	12.078066844523805	12.133831266165176	12.184263639507078	12.22945777970943	12.269507781377309	12.304507367938225	12.334549314130292	12.35972494114419	12.380123682754034	12.39583271973061	12.406936678882461	12.413517392355635	12.415653712204843	12.413421374837377	12.406892909640382	12.396137585979224	12.381221392729437	12.362207044644585	12.339154010037042	12.31211855458511	12.281153796398502	12.246309767920291	12.207633480665379	12.165168989247984	12.118957451645866	12.06903718303899	12.015443701043555	11.958209760510096	11.897365376423995	11.832937833748069	11.764951683292415	11.693428722926408	11.618387963548361	11.539845579395488	11.457814842308155	11.372306039563364	11.283326374922769	11.190879852472062	11.094967142772544	10.995585430790019	10.892728244966666	10.786385266723459	10.676542119621272	10.563180137361845	10.446276109688812	10.3258020053217	10.201724671045225	10.07400550597844	9.942600110296736	9.807457907631589	9.668521740583813	9.525727438848476	9.379003359808387	9.228269901560052	9.073438988691235	8.914413531532169	8.751086859876617	8.583342132801928	8.411051726573314	8.234076603479895	8.05226566490939	7.865455092973095	7.673467685844155	7.476112193065783	7.273182658288517	7.064457778238113	6.849700288412783	6.628656387475522	6.401055214681095	6.166608396492031	5.925009681251739	5.6759346834168625	5.41904076187114	5.153967060032825	4.880334739231809	4.59774744035939	4.305792013195397	4.004039556722776	3.692046818507369	3.3693580053737167	3.035507062186317	2.690020479685677	2.3324206960241862	1.9622301597266407	1.5789761239021314	1.1821962420568068	0.7714450345922421	0.34630129134864657	-0.09362353176502441	-0.5486758748085283	-1.0191495638091392	-1.5052742200063136	-2.0072026095616584	-2.5249969929458986	-3.0586145810303225	-3.6078922638325635	-4.172530847369905	-4.752079115756934	-5.3459181262729185	-5.953246244975354	-6.573065531474982	-7.20417018078097	-7.845137815753748	-8.494324485270527	-9.1498642483439	-9.80967419723899	-10.47146568302403	-11.132762342489137	-11.790925285475033	-12.443185486504856	-13.086683050785963	-13.71851261178392	-14.335773699035856	-14.93562452418662	-15.515337310812866	-16.072353072451598	-16.604333649405547	-17.10920886616867	-17.585216865252168	-18.030936000505115	-18.445307105018287	-18.82764545233775	-19.177642262131428	-19.495356121755517	-19.78119516381484	-20.035891225675527	-20.260467497273712	-20.456201329158887	-20.624583921588194	-20.76727856030845	-20.886078921429807	-20.98286875955055	-21.059584045282346	-21.118178352624277	-21.160592035565404	-21.188725491879982	-21.204416602527967	-21.209422263400423	-21.205403794715203	-21.19391592078516	-21.176398955364014	-21.154173800164237	-21.128439360597977	-21.100271997251912	-21.070626659161825	-21.040339380418	-21.010130861476853	-20.980610897742967	-20.952283457984635	-20.925552252547725	-20.900726664782727	-20.8780279479124	-20.85759561335776	-20.83949395488291	-20.823718666188114	-20.810203517720293	-20.79882706172622	-20.789419334040343	-20.781768516690143	-20.775627518682935	-20.77072042375028	-20.766748744837997	-20.763397416601087	-20.760340450444904	-20.75724617272779	-20.753781966563	-20.749618441944932	-20.744432968224235	-20.737912517024956	-20.729755782714705	-20.7196745702081	-20.70739446566612	-20.692654832712616	-20.67520820371348	-20.654819160652917	-20.631262821465143	-20.60432306374096	-20.57379062740813	-20.539461240259993	-20.50113390494698	-20.4586094732545	-20.41168961400063	-20.360176255892775	-20.303871557668487	-20.242578426704753	-20.17610157593359	-20.104249079141304	-20.02683435836464	-19.943678515411584	-19.854612903568867	-19.759481825854866	-19.658145242839606	-19.550481375745907	-19.436389098647197	-19.3157900260254	-19.18863021776922	-19.054881441470943	-18.914541950598846	-18.76763675551566	-18.61421738155	-18.45436112352682	-18.288169818929706	-18.115768171727964	-17.93730166587534	-17.75293411157546	-17.56284486883045	-17.36722579187892	-17.16627793529754	-16.96020805812884	-16.749224956968423	-16.533535652762506	-16.31334144960673	-16.088833877371098	-15.860190523780611	-15.627570755836587	-15.39111132537761	-15.150921849142167	-14.907080150086529	-14.659627443628356	-14.408563350383995	-14.153840715094569	-13.89536021020225	-13.632964701476872	-13.366433352048128	-13.095475440154441	-12.81972386418702	-12.538728306603609	-12.251948025295821	-11.958744237209142	-11.65837205425438	-11.349971926368985	-11.032560540822931	-10.705021122077099	-10.36609307345778	-10.014360902781968	-9.648242382039843	-9.265975909598758	-8.865607078459233	-8.444974512110033	-8.00169512045356	-7.533149063378683	-7.036464903915405	-6.5085057035166916	-5.945857180334338	-5.344819539559793	-4.701405217091184	-4.011345575457658	-3.2701105663067445	-2.4729465235406916	-1.6149385387938853	-0.6911052075374517	0.3034652515318506	1.3734277009635698	2.5229318861332386	3.7553052339144677	5.072662649180086	6.47544701146434	7.961916518517756	9.527612892538505	11.164867070664064	12.862422995009178	14.60527821425246	16.374840873736428	18.149473604442676	19.905428275418675	21.618078210592333	23.263253453123042	24.81842382209757	26.263496304785594	27.581112202180126	28.756512585225483	29.777212919788585	30.632804982981128	31.315138816547464	31.818949322613697	32.14276377506591	32.289762949814694	32.26824342990786	32.09144800305573	31.776734745225266	31.34425274232412	30.81540925768653	30.211422386096057	29.552175962277552	28.855477316953042	28.136710329366338	27.40880464117304	26.682413391688183	25.96619735713359	25.267137800544923	24.59082986206942	23.94173397624434	23.3233807404159	22.738534714835005	22.189326556919102	21.677362935387514	21.20382178908728	20.76953804207597	20.37508261454936	20.02083578617955	19.707054707975757	19.43393402566919	19.201658044478595	19.01044252528307	18.86056399240946	18.752374335683594	18.686298523864924	18.662813457059222	18.68240642780188	18.74551238635246	18.852430252868498	19.003219900465826	19.197583127520858	19.43473388471693	19.713265117535542	20.031021676813033	20.38499063935958	20.771221821946952	21.184791980705562	21.61982585288227	22.069585509910524	22.526636184765685	22.983091654111906	23.430935425445995	23.86240569937175	24.270422986831456	24.6490303654852	24.993808978173742	25.302226993610137	25.573880259415173	25.81058826258538	26.01632001646788	26.196940391556367	26.35978645868436	26.51310305812434	26.665384097595005	26.824678254196538	26.997922811602447	27.190366493888746	27.405131892150035	27.642952141498355	27.90209740927066	28.17848728096092	28.465967810631135	28.756718732302595	29.04174816625685	29.311429309004396	29.556035564483764	29.76623635836551	29.93352422306723	30.050553353817694	30.11137954601387	30.111600292519665	30.048401190031704	29.920520309000935	29.728145715281705	29.47276300013626	29.15696973634735	28.784272580049848	28.358880661704337	27.88550632325597	27.36918148385174	26.815095210062573	26.228455612418557	25.61437710391147	24.977792391858756	24.32338734084351	23.655556013269628	22.978372717410714	22.295577709576676	21.610573242356935	20.926426862653468	20.245879184038703	19.571353739647737	18.904966925660286	18.248536442701283	17.603587015133492	16.971352506443154	16.35277385153113	15.748492497910139	15.158839295863071	14.583819012285895	14.023090873020795	13.475945769444719	12.941280996763169	12.417573616082246	11.902853732661752	11.394679131959688	10.890112775870612	10.385704588995335	9.877478708622883	9.360926881752569	8.831007925184727	8.282152089390042	7.708267774338822	7.102746349913155	6.458458871882798	5.76773630956827	5.0223225669468174	4.213287115140094	3.330881447142525	2.36432072888291	1.3014687930403572	0.1284007819705767	-1.171186912172336	-2.6167552633512163	-4.231931478211859	-6.045794249332406	-8.094480126336785	-10.423138181852144	-13.088203418692185	-16.159812808392527	-19.7238423861618	-23.88227555160669	-28.74900687486189	-34.43512318167695	-41.01269670262679	-48.44008679474715	-56.42970622109752	-64.25346711705568	-70.53023441228598	-73.13451787490457	-69.47452320706286	-57.38779348051679	-36.58938386589305	-9.929587556038761	16.766610331494054	36.80707702616308	45.49265133413475	41.800944183625894	28.274873735348585	9.712263084432191	-8.829127713947722	-23.75922696418008	-33.64977289307627	-38.89530683545099	-40.76510778117236	-40.5483607631502	-39.150675097651664	-37.04758198034058	-34.38736565181248	-31.120770897069544	-27.116849551905677	-22.257789931855942	-16.510910577432647	-9.971995269372746	-2.8703798826864104	4.468437805960417	11.676530108407906	18.373487388252265	24.195281950716147	28.842768718757757	32.12173367814701	33.95518980716499	34.36972944859329	33.46806179633954	31.399925837953237	28.33760605151969	24.45819290308709	19.933207571664965	14.925059221054909	9.588663786843352	4.075848771630728	-1.459843787881771	-6.8598063826588875	-11.959693498789186	-16.59230393888	-20.594715919699773	-23.819945678613973	-26.152365143194814	-27.52433497863209	-27.9292936718577	-27.425366504593743	-26.12589031039615	-24.179376486400947	-21.74694270325622	-18.98543950876176	-16.040245358228212	-13.047208095593257	-10.140608312046158	-7.462949822480033	-5.172267869165521	-3.4433828779559397	-2.4612340233782013	-2.4072188550743903	-3.4423352712794384	-5.690746533901264	-9.220904083811481	-14.010168518979574	-19.875725309866986	-26.379833478698664	-32.76609861307639	-38.01159019984622	-41.05349793022043	-41.156165744131364	-38.238795371628804	-32.85843129562779	-25.50261068517388	-16.414414771877716	-8.92520694229556	-8.072245146078387	-10.834896220403492	-8.793064280894965	-5.308228012805314	-11.290690986330253	-21.696339307812853	-34.440604204738115	-46.59944590785906	-45.82984413797587]


using ConstrainedDynamics
using ConstrainedDynamicsVis
using ConstrainedControl
using LinearAlgebra
using Rotations
using Rotations: rotation_error

# Trajectory Generation from U

# Parameters
ex = [1.0;0.0;0.0]
ey = [0.0;1.0;0.0]

length1 = 1.0
width, depth = 0.1, 0.1
cartshape = Box(0.1, 0.5, 0.1, length1/2)
poleshape = Box(width, depth, length1, length1)

p2 = [0.0;0.0;length1/2] # joint connection point

# Desired orientation
ϕ = 0.

# Links
origin = Origin{Float64}()
cart = Body(cartshape)
pole1 = Body(poleshape)
pole2 = Body(poleshape)
pole3 = Body(poleshape)

# Constraints
joint1 = EqualityConstraint(Prismatic(origin, cart, ey))
joint2 = EqualityConstraint(Revolute(cart, pole1, ex; p2=p2))
joint3 = EqualityConstraint(Revolute(pole1, pole2, ex; p1 = -p2, p2=p2))
joint4 = EqualityConstraint(Revolute(pole2, pole3, ex; p1 = -p2, p2=p2))

links = [cart;pole1;pole2;pole3]
constraints = [joint1;joint2;joint3;joint4]
shapes = [cartshape;poleshape]


mech = Mechanism(origin, links, constraints, shapes = shapes, g=-9.81,Δt = 0.01)
setPosition!(origin,cart,Δx = [0;0.0;0])
setPosition!(cart,pole1,p2 = p2,Δq = UnitQuaternion(RotX(ϕ+0)))
setPosition!(pole1,pole2,p1 = -p2,p2 = p2,Δq = UnitQuaternion(RotX(0.)))
setPosition!(pole2,pole3,p1 = -p2,p2 = p2,Δq = UnitQuaternion(RotX(0.)))

function control!(mechanism, k)
    setForce!(mechanism, geteqconstraint(mechanism,5), [U[k]])
end

steps = Base.OneTo(1000)
storage0 = Storage{Float64}(steps,4)

simulate!(mech,storage0,control!,record = true);



# Tracking Control

setPosition!(origin,cart,Δx = [0;0.0;0])
setPosition!(cart,pole1,p2 = p2,Δq = UnitQuaternion(RotX(0.)))
setPosition!(pole1,pole2,p1 = -p2,p2 = p2,Δq = UnitQuaternion(RotX(0.)))
setPosition!(pole2,pole3,p1 = -p2,p2 = p2,Δq = UnitQuaternion(RotX(0.)))

Q = [diagm(ones(12))*0.0 for i=1:4]
Q[1][2,2] = 10
Q[1][5,5] = 1
Q[2][7,7] = 40
Q[2][10,10] = 1
Q[3][7,7] = 40
Q[3][10,10] = 1
Q[4][7,7] = 40
Q[4][10,10] = 1
R = [ones(1,1)*0.1]


function owncontrol_trackinglqr!(mechanism::Mechanism{T,Nn,Nb}, lqr::TrackingLQR{T,N}, k) where {T,Nn,Nb,N}
    Δz = zeros(T,Nb*12)
    qvm = QuatVecMap()
    for (id,body) in pairs(mechanism.bodies)
        colx = (id-1)*12+1:(id-1)*12+3
        colv = (id-1)*12+4:(id-1)*12+6
        colq = (id-1)*12+7:(id-1)*12+9
        colω = (id-1)*12+10:(id-1)*12+12

        state = body.state
        Δz[colx] = state.xsol[2]-lqr.xd[k][id]
        Δz[colv] = state.vsol[2]-lqr.vd[k][id]
        Δz[colq] = rotation_error(state.qsol[2],lqr.qd[k][id],qvm)
        Δz[colω] = state.ωsol[2]-lqr.ωd[k][id]
    end

    v1 = mechanism.bodies[1].state.vc[2]
    ω2 = mechanism.bodies[2].state.ωc[1]
    ω3 = mechanism.bodies[3].state.ωc[1] - ω2
    ω4 = mechanism.bodies[4].state.ωc[1] - ω2 - ω3

    ucart = -sign(v1)*0.1*abs(v1) + randn()*2
    up2 = -sign(ω2)*0.1*abs(ω2)
    up3 = -sign(ω3)*0.1*abs(ω3)
    up4 = -sign(ω4)*0.1*abs(ω4)

    if k<N
        for (i,id) in enumerate(lqr.eqcids)
            u = lqr.Fτd[k][i] - lqr.K[k][i]*Δz + ucart
            setForce!(mechanism, geteqconstraint(mechanism, id), u)
        end

        setForce!(mechanism, geteqconstraint(mechanism,6), [up2])
        setForce!(mechanism, geteqconstraint(mechanism,7), [up3])
        setForce!(mechanism, geteqconstraint(mechanism,8), [up4])
    end

    return
end

lqr = TrackingLQR(mech, storage0, [[[U[k]]] for k=1:1000], [5], Q, R, controlfunction = owncontrol_trackinglqr!)

function uncontrol!(mechanism, k)
    v1 = mechanism.bodies[1].state.vc[2]
    ω2 = mechanism.bodies[2].state.ωc[1]
    ω3 = mechanism.bodies[3].state.ωc[1] - ω2
    ω4 = mechanism.bodies[4].state.ωc[1] - ω2 - ω3

    ucart = U[k] - sign(v1)*0.1*abs(v1) + randn()*2
    up2 = -sign(ω2)*0.1*abs(ω2)
    up3 = -sign(ω3)*0.1*abs(ω3)
    up4 = -sign(ω4)*0.1*abs(ω4)

    setForce!(mechanism, geteqconstraint(mechanism,5), [ucart])
    setForce!(mechanism, geteqconstraint(mechanism,6), [up2])
    setForce!(mechanism, geteqconstraint(mechanism,7), [up3])
    setForce!(mechanism, geteqconstraint(mechanism,8), [up4])
end


steps = Base.OneTo(1000)
storage = Storage{Float64}(steps,4)

setPosition!(origin,cart,Δx = [0;0;0])
setPosition!(cart,pole1,p2 = p2)
setPosition!(pole1,pole2,p1 = -p2,p2 = p2)
setPosition!(pole2,pole3,p1 = -p2,p2 = p2)
setVelocity!(cart)
setVelocity!(pole1)
setVelocity!(pole2)
setVelocity!(pole3)
# simulate!(mech,storage,control!,record = true)
simulate!(mech,storage,uncontrol!,record = true)

visualize(mech,storage,shapes)